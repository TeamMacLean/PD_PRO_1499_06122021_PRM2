---
title: "Pathways in MS1"
author: "Clara JÃ©gousse"
date: "`r Sys.Date()`"
output: html_document
---


# Objectives

According to Neftaly, the objectives are:

To retrieve the phosphorylation values (scaled abundance) of phosphopeptides found for all of these proteins in the MS1 dataset at all time points.

To plot small heatmaps for each pathway with all the phosphopeptides found for their proteins in the strains Guy11 and Dpmk1

# Libraries

```{r, warning=FALSE, message=FALSE}
library(here)
library(readr)
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(openxlsx)

library(ComplexHeatmap)
```


```{r}
results_dir = paste(here(), "results", sep = "/")
```


# Load the data

## Selected proteins and pathways

Let's start by loading the selected phosphopeptides:

```{r, warning=FALSE}
pathways_filepath = paste0(here::here(), "/data/cleaned/013_pathways.xlsx")
pathways = read_xlsx(pathways_filepath)
```

There are 91 proteins representing 6 pathways

```{r}
dim(pathways)
unique(pathways$pathway) %>% length()
unique(pathways$id_number) %>% length()
```


## MS1 data


### Load and clean the data

```{r}
ms1_filepath = paste0(here::here(), "/data/cleaned/ms1_cleaned.csv")
cleaned = read_csv(ms1_filepath)
```

```{r}
cleaned %>% filter(sample == "dpmk1" & time == 0)
```

# Curation

```{r}


ms1_curated_filepath = paste0(here::here(), "/data/raw/013_curation/ms1_curated.csv")
to_be_removed = read_csv(ms1_curated_filepath) %>% 
  filter(KEEP == FALSE) 

#head(to_be_removed$id)

#head(to_be_removed)

cleaned = cleaned %>%
  mutate(id = paste(`Positions in Master Proteins`, `Modifications`, `Annotated Sequence`, sep = "|")) %>%
  filter(id %in% to_be_removed$id == FALSE) %>%
  select(-id)
```


### Build the matrix

The long dataframe needs pivot-ing into a matrix. Scaling is applied too. 

```{r}
ms1_tb <- cleaned %>%
  mutate(sample_time = paste(sample, time, sep="-"),
         id = paste(`Positions in Master Proteins`, 
           `Annotated Sequence`, `Modifications`, 
           `Label Modifications in Master Proteins`,  
           sep = "|")) %>%
  select(id, sample_time, value) %>%
  pivot_wider(names_from = "sample_time", values_from = "value" )

m = ms1_tb
rows <- m$id
m$id <- NULL
raw_m <- as.matrix(m)
```


### Labels

```{r}
raw_filepath = paste0(here::here(), "/data/raw/Nrc210121_rgm2r_1to6hrsMS1Q.xlsx")
raw = read_excel(raw_filepath)
```


```{r}
raw %>% 
  mutate(modif_position_label = str_extract_all(`Modifications in Master Proteins`, "\\[(.*)\\]", simplify = TRUE) %>%
   gsub("\\[|\\]", "", .) %>%
  gsub("\\s*\\([^\\)]+\\)", "", .) %>%
  str_replace(., "N-Term; ", "") %>%
  str_replace(., "1xPhospho ", "") %>%
  str_replace(., "2xPhospho ", "")) %>%
  mutate(id = paste(`Positions in Master Proteins`, `Modifications`,  sep = "-")) %>%
  select(id, modif_position_label)

```


### Replace missing values

We can also replace NA with the minimum observed value on the whole abundance data - before scaling and distance measuring.

```{r}
m <- raw_m
m[is.na(m)] <- min(m, na.rm=TRUE)
```

### Scaling

```{r}
m_scaled <- t(apply(m, 1, function(x)(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x,na.rm = TRUE))))
```

Assign column names and row names to the scaled matrix

```{r}
colnames(m_scaled)
rownames(m_scaled) = ms1_tb$id
```

Check the dimensions of our matrix

```{r}
dim(m_scaled)
```

# Heatmaps

We create an empty heatmap list that will store all the heatmaps:

```{r}
hm_list = list()
```

We set a colour scheme matching the original Excel document in which each pathway correspond to one colour:

```{r}
pathway_colours = c(
  'gold', 'orange', 'darkolivegreen3', 
  'deepskyblue4', 'darkgrey', 'salmon', 'orchid4', "seagreen")
names(pathway_colours) = unique(pathways$pathway)
```

Then, using a loop, we make one heatmap for each pathway:

```{r}
m = m_scaled

for (p in unique(pathways$pathway)) {
  
  #print(p)
  
  # retrieve the list of all the protein names and id number for the pathway p 
  selected_pathway = pathways %>% filter(pathway == p)
  
  # filter out the MS1 scaled abundance values for the proteins (peptides) involved in the selected_pathway
  selected_ms1 = m[grepl(paste(selected_pathway$id_number, collapse = "|"), ms1_tb$id),]
  
  # store the row information (peptide and gene identifiers)
  row_infos = data.frame(m_rownames = rownames(selected_ms1))
  
  # build the protein id number from the gene number (removed the last two caracter 'T0')
  row_infos = row_infos %>% mutate(
    id_number = stringr::str_sub(m_rownames, end = 9)
    )
  
  # join all the row information
  row_infos = left_join(row_infos, selected_pathway, by = "id_number", keep = FALSE)
  
  # 'bind' together the matrix of scaled abundance values and the row information
  mdata = list(row_info = row_infos, data = selected_ms1)
  
  # build a matrix to use the ComplexHeatmap package
  matrix <- mdata$data
  rownames(matrix) <- paste(mdata$row_info[,'protein_name'],
    mdata$row_info[,'id_number'],
    str_split( mdata$row_info[,'m_rownames'], "\\|", n = Inf, simplify = TRUE)[,4])
  colnames(matrix) <- colnames(mdata$data)
  
  # create the colour gradient matching the colour representing the pathway
  col_fun = circlize::colorRamp2(c(0, 1), c( "white", pathway_colours[p]))
  
  # set the title of the legend
  lgd_title = paste0("Scaled\nabundance\n(", p, ")")
  
  # organise columns according to genotype and timepoints
  col_split = factor(paste(stringr::str_split(colnames(matrix), "_", 
    n = 3, 
    simplify = TRUE)[,1]))
  
  # build the heatmap
  hm = ComplexHeatmap::Heatmap(matrix, 
    #column_split = col_split, 
    column_gap = grid::unit(0.25, "cm"), 
    column_order = levels(col_split),
    show_column_names = TRUE,
    column_title = p,
    row_order = rownames(matrix), 
    show_row_names = TRUE,
    row_names_side = "left",
    rect_gp = grid::gpar(col = "white", lwd = 2 ), 
    col = col_fun,
    show_heatmap_legend = FALSE,
    heatmap_legend_param = list(title = lgd_title)
  )

  # store the heatmap in our list
  hm_list[[p]] = hm
}
```


```{r,include=FALSE}
#Plot all the heatmap together
ComplexHeatmap::draw(hm_list$CpkA %v% hm_list$pmk1 %v% hm_list$`Sln1/HOG` %v% hm_list$`Septin-oligomerisation` %v% hm_list$Vast %v% hm_list$Autophagy)
```

# Single heatmap

Here we draw all the heatmaps using the viridis colour palette and we combine them for plotting at the end.

```{r}
# use viridis
pal <- viridis::viridis_pal()
colours <- pal(11)

library(circlize)
col_fun = colorRamp2(seq(0,1, by=0.1), colours)
lgd = Legend(col_fun = col_fun, title = "Scaled\nabundance")

for (p in unique(pathways$pathway)) {
  
  #print(p)
  
  # retrieve the list of all the protein names and id number for the pathway p 
  selected_pathway = pathways %>% filter(pathway == p)
  
  # filter out the MS1 scaled abundance values for the proteins (peptides) involved in the selected_pathway
  selected_ms1 = m[grepl(paste(selected_pathway$id_number, collapse="|"), ms1_tb$id),]
  
  
  xlsx_filename = paste0(results_dir, "/", "013-ms1-pathways-", p, ".xlsx")
  write.xlsx(as.data.frame(selected_ms1), 
    xlsx_filename, keepNA = TRUE, rowNames = TRUE)
  
  # store the row information (peptide and gene identifiers)
  row_infos = data.frame(m_rownames = rownames(selected_ms1))
  
  # build the protein id number from the gene number (removed the last two caracter 'T0')
  row_infos = row_infos %>% mutate(
    id_number = stringr::str_sub(m_rownames, end = 9))
  
  # join all the row information
  row_infos = left_join(row_infos, selected_pathway, by = "id_number", keep = FALSE)
  
  row_ha = ComplexHeatmap::rowAnnotation(pathway = row_infos$pathway,
  col = list(pathway = pathway_colours),
  simple_anno_size = grid::unit(0.5, "cm"), 
  show_legend = FALSE, 
  annotation_legend_param = list(pathway = list(title = "")),
  show_annotation_name = FALSE
  #annotation_name_gp = grid::gpar(fontsize = 8, col = "white")#,
  #gp = grid::gpar(col = "black", lwd = 1)
  )
  
  # 'bind' together the matrix of scaled abundance values and the row information
  mdata = list(row_info = row_infos, data = selected_ms1)
  
  # build a matrix to use the ComplexHeatmap package
  matrix <- mdata$data

   rownames(matrix) <- paste(
    str_replace(str_split(mdata$row_info[,'m_rownames'], "\\|", n = Inf, simplify = TRUE)[,1], "\\s*\\[[^\\)]+\\]", ""),
     mdata$row_info[,'protein_name'],
       #str_split(str_split( mdata$row_info[,'m_rownames'], "\\|", n = Inf, simplify = TRUE)[,2], "\\.", n = Inf, simplify = TRUE)[,2],
    paste0("(", str_replace(str_split( mdata$row_info[,'m_rownames'], "\\|", n = Inf, simplify = TRUE)[,4], "M+\\d+;", ""), ")"))
  
  colnames(matrix) <- colnames(mdata$data)
  
  # organise columns according to genotype and timepoints
  col_split = factor(stringr::str_split(colnames(matrix), "-", n = 2, simplify = TRUE)[,1], levels = c("Guy11", "dpmk1"))
  
  col_order = colnames(matrix)
  
  # build the heatmap
  hm = ComplexHeatmap::Heatmap(matrix, 
    column_split = col_split, 
    column_gap = grid::unit(0.25, "cm"), 
    column_order = col_order,
    show_column_names = TRUE,
    column_title = NULL,
    #column_title = p,
    width = grid::unit(5, "cm"),
    #height = grid::unit(5, "cm"),
    row_order = rownames(matrix), 
    show_row_names = TRUE,
    row_names_side = "right",
    left_annotation = row_ha,
    rect_gp = grid::gpar(col = "white", lwd = 0.5 ), 
    col = col_fun,
    show_heatmap_legend = FALSE,
    heatmap_legend_param = list(title = "Scaled"),
    column_names_gp = grid::gpar(fontsize = 8),
    row_names_gp = grid::gpar(fontsize = 2)
  )

  # store the heatmap in our list
  hm_list[[p]] = hm
  
  graphics_dir = paste(here(), "graphics", sep = "/")
  pdf_name = gsub('/', '-', paste0("013-ms1-pathway-", p, ".pdf"))
  pdf_filename = paste(graphics_dir, pdf_name, sep = "/")
  pdf(file = pdf_filename, width = 12, height = 10 )
  print(hm)
  dev.off()
}
```


```{r}
ht_list = hm_list[[1]] %v% hm_list[[2]] %v% hm_list[[3]] %v% hm_list[[4]] %v% hm_list[[5]] %v% hm_list[[6]] %v% hm_list[[7]] 
 
graphics_dir = paste(here(), "graphics", sep = "/")
pdf_filename = paste(graphics_dir, "013-ms1-pathways.pdf", sep = "/")
pdf(file = pdf_filename, height = 12, width = 8.27)
ComplexHeatmap::draw(ht_list)
ComplexHeatmap::draw(lgd, x = grid::unit(18, "cm"), y = grid::unit(12, "cm"))
dev.off()
```


# Steve proteins

For a collaborator interested in knowing the phosphorylation of the proteins he is working with (Steve proteins)

```{r, eval=FALSE}
graphics_dir = paste(here(), "graphics", sep = "/")
pdf_filename = paste(graphics_dir, "013-ms1-pathways-steve.pdf", sep = "/")
pdf(file = pdf_filename, height = 4, width = 10)
hm_list[[8]]
dev.off()
```

