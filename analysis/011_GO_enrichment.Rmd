---
title: "011 GO enrichment"
author: "Clara JÃ©gousse"
date: "2022-10-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preliminary settings

### Libraries

```{r, message=FALSE}
library(readr)
library(stringr)
library(dplyr)

library(mogo)
library(clusterProfiler)
library(viridis)
```

## Cluster 1

### Load data

Read data from csv file and select the transcript identifiers (e.g. `MGG_07200T0`).

```{r, message=FALSE}
cluster1 = read_csv('/Users/jegoussc/GitHub/PD_PRO_1499_06122021_PRM2/analysis/010_kmeans_cluster_ 1 _on_guy11_and_dpmk1.csv') %>% 
  dplyr::select(id)
```

Convert transcript identifier to gene identifier (e.g. from `MGG_07200T0` to `MGG_07200`) and **collapse duplicate gene identifiers**: for example, transcript `MGG_07200T0` (gene `MGG_07200`) appears twice in cluster 1 because it correspond to a protein with two phosphorylation sites (`[1-38]-1xMet-loss+Acetyl [N-Term];1xPhospho [S20(91.8)]` and `[1-38]-1xMet-loss+Acetyl [N-Term];1xPhospho [T16(96.9)]`); in this case, we only keep the one instance of the transcript/gene identifier to avoid over-estimating the representation of the GO term(s) associated with this transcript/gene identifier.

```{r}
clust1 = cluster1 %>% mutate(gene_ids = str_split(id, " ", n = 2, simplify = TRUE)[,1]) %>%
  mutate(gene_ids = str_remove(gene_ids, "T0")) %>%
  dplyr::select(gene_ids) %>% 
  unique() # collapse duplicates of the same gene identifier
```

### GO Enrichment

Perform the GO enrichment analysis

```{r, message=FALSE}
enrich1 <- do_enrich(clust1$gene_ids)
```

```{r, message=FALSE}
barplot(enrich1) + 
  scale_fill_viridis(direction = -1) + 
  ggplot2::theme(aspect.ratio = 1)
```

```{r, message=FALSE}
dotplot(enrich1) + 
  scale_colour_viridis(direction = -1)
```

### Write results in CSV 

```{r}
enrich1_df = as.data.frame(enrich1) %>%
  select(ID, geneID, Description, GeneRatio, BgRatio, pvalue, p.adjust, qvalue)

csv_filename = "011_cluster1_go_enrichment.csv"
write_csv(enrich1_df, csv_filename)
```

## Cluster 2

### Load data

Read data from csv file.

```{r, message=FALSE}
cluster2 = read_csv('/Users/jegoussc/GitHub/PD_PRO_1499_06122021_PRM2/analysis/010_kmeans_cluster_ 2 _on_guy11_and_dpmk1.csv') %>% 
  dplyr::select(id)
```

Keep only the gene id

```{r}
clust2 = cluster2 %>% mutate(gene_ids = str_split(id, " ", n = 2, simplify = TRUE)[,1]) %>%
  mutate(gene_ids = str_remove(gene_ids, "T0")) %>%
  dplyr::select(gene_ids) %>% 
  unique()
```

### GO Enrichment

```{r, message=FALSE}
enrich2 <- do_enrich(clust2$gene_ids)
```

```{r, message=FALSE}
barplot(enrich2) + 
  scale_fill_viridis(direction = -1) + 
  ggplot2::theme(aspect.ratio = 1)
```

```{r, message=FALSE}
dotplot(enrich2) + 
  scale_colour_viridis(direction = -1)
```

### Write results in CSV 

```{r}
enrich2_df = as.data.frame(enrich2) %>%
  select(ID, geneID, Description, GeneRatio, BgRatio, pvalue, p.adjust, qvalue)

csv_filename = "011_cluster2_go_enrichment.csv"
write_csv(enrich2_df, csv_filename)
```

## Cluster 3

### Load data

Read data from csv file.

```{r, message=FALSE}
cluster3 = read_csv('/Users/jegoussc/GitHub/PD_PRO_1499_06122021_PRM2/analysis/010_kmeans_cluster_ 3 _on_guy11_and_dpmk1.csv') %>% dplyr::select(id)
```

Keep only the gene id

```{r}
clust3 = cluster3 %>% mutate(gene_ids = str_split(id, " ", n = 2, simplify = TRUE)[,1]) %>%
  mutate(gene_ids = str_remove(gene_ids, "T0")) %>%
  dplyr::select(gene_ids) %>% unique()
```

### GO Enrichment

```{r, message=FALSE}
enrich3 <- do_enrich(clust3$gene_ids)
```

```{r, message=FALSE}
barplot(enrich3) + scale_fill_viridis(direction = -1) + ggplot2::theme(aspect.ratio = 1)
```

```{r, message=FALSE}
dotplot(enrich3) + scale_colour_viridis(direction = -1)
```

### Write results in CSV 

```{r}
enrich3_df = as.data.frame(enrich3) %>%
  select(ID, geneID, Description, GeneRatio, BgRatio, pvalue, p.adjust, qvalue)

csv_filename = "011_cluster3_go_enrichment.csv"
write_csv(enrich3_df, csv_filename)
```

## Cluster 4

### Load data

Read data from csv file.

```{r, message=FALSE}
cluster4 = read_csv('/Users/jegoussc/GitHub/PD_PRO_1499_06122021_PRM2/analysis/010_kmeans_cluster_ 4 _on_guy11_and_dpmk1.csv') %>% 
  dplyr::select(id)
```

Keep only the gene id

```{r}
clust4 = cluster4 %>% mutate(gene_ids = str_split(id, " ", n = 2, simplify = TRUE)[,1]) %>%
  mutate(gene_ids = str_remove(gene_ids, "T0")) %>%
  dplyr::select(gene_ids) %>% 
  unique()
```

### GO Enrichment

```{r, message=FALSE}
enrich4 <- do_enrich(clust4$gene_ids)
```

```{r, message=FALSE}
barplot(enrich4) + 
  scale_fill_viridis(direction = -1) + 
  ggplot2::theme(aspect.ratio = 1)
```

```{r, message=FALSE}
dotplot(enrich4) + 
  scale_colour_viridis(direction = -1)
```

### Write results in CSV 

```{r}
enrich4_df = as.data.frame(enrich4) %>%
  select(ID, geneID, Description, GeneRatio, BgRatio, pvalue, p.adjust, qvalue)

csv_filename = "011_cluster4_go_enrichment.csv"
write_csv(enrich3_df, csv_filename)
```

## Cluster 5

### Load data

Read data from csv file.

```{r, message=FALSE}
cluster5 = read_csv('/Users/jegoussc/GitHub/PD_PRO_1499_06122021_PRM2/analysis/010_kmeans_cluster_ 5 _on_guy11_and_dpmk1.csv') %>% 
  dplyr::select(id)
```

Keep only the gene id

```{r}
clust5 = cluster5 %>% mutate(gene_ids = str_split(id, " ", n = 2, simplify = TRUE)[,1]) %>%
  mutate(gene_ids = str_remove(gene_ids, "T0")) %>%
  dplyr::select(gene_ids) %>% 
  unique()
```

### GO Enrichment

```{r, message=FALSE}
enrich5 <- do_enrich(clust5$gene_ids)
```

```{r, message=FALSE}
barplot(enrich5) + 
  scale_fill_viridis(direction = -1) + 
  ggplot2::theme(aspect.ratio = 1)
```

```{r, message=FALSE}
dotplot(enrich5) + 
  scale_colour_viridis(direction = -1)
```

### Write results in CSV 

```{r}
enrich5_df = as.data.frame(enrich5) %>%
  select(ID, geneID, Description, GeneRatio, BgRatio, pvalue, p.adjust, qvalue)

csv_filename = "011_cluster5_go_enrichment.csv"
write_csv(enrich5_df, csv_filename)
```

